<script lang="ts" setup>
import { ApiMemberExists, ApiMemberPhoneSms, ApiMemberUpdate } from '@tg/apis'
import { BaseImage, PhBaseButton, PhBaseInput, PhBaseLabel, PhBaseOriginSelect } from '@tg/bccomponents'
import { useAreaCode, useBoolean, useCountDown, useIpApi } from '@tg/hooks'
import { useAppStore, useBrandStore } from '@tg/stores'
import { brazilPhoneReg, chinaPhoneReg, numberReg, philippinePhoneReg } from '@tg/utils'
import { storeToRefs } from 'pinia'
import { useField } from 'vee-validate'
import { computed, ref, watch } from 'vue'
import { useI18n } from 'vue-i18n'
import { useRequest } from 'vue-request'
import { Message } from '~/utils'

interface Props {
  isComponent?: boolean
}
defineOptions({ name: 'PhoneSetting' })

const props = withDefaults(defineProps<Props>(), {
  isComponent: false,
})
const emit = defineEmits(['toggle'])
const { areaSearchValue, areaCodeOptionsFiltered, clearAreaSearchValue, areaCodeOptions, areaCodeData } = useAreaCode()
const { isOpenMobileVerify, isOpenEmailVerify } = storeToRefs(useBrandStore())
const { t } = useI18n()
const { countryCallingCode } = useIpApi()
const phoneRef = ref()
const codeRef = ref()
const { bool: isCountdown } = useBoolean(false)
const { userInfo, isSetPayPwd, isLogin } = storeToRefs(useAppStore())
const { updateUserInfo } = useAppStore()
const area_code = ref(areaPlus(userInfo.value?.phone.split('-')[0]) || countryCallingCode.value || '+86')
const areaCodeLabel = computed(() => areaCodeOptions.value?.find(a => a.value === area_code.value)?.label ?? '')
const phoneVerified = computed(() => userInfo.value?.phone_check_state === 1)

// 添加区号数据加载状态检查
const isAreaCodeDataReady = computed(() => {
  return areaCodeData.value && areaCodeData.value.length > 0
})

// 确保 areaCodeOptionsFiltered 在数据未加载完成时有默认值
const safeAreaCodeOptionsFiltered = computed(() => {
  if (!isAreaCodeDataReady.value) {
    // 如果数据未加载完成，返回一个默认的区号选项
    return [{ label: '+86', value: '+86' }]
  }
  return areaCodeOptionsFiltered.value
})

// 添加加载状态显示
const showAreaCodeLoading = computed(() => {
  return !isAreaCodeDataReady.value && areaCodeData.value === undefined
})

const paramsData = ref({
  uid: '',
  telegram: '',
  facebook: '',
  zalo: '',
  line: '',
  viber: '',
  whatsapp: '',
  twitter: '',
  wechat: '',
  qq: '',
  /** 性别 1=男，2=女 */
  sex: 1,
  cpf: '',
})

const {
  start,
  reset,
  current,
} = useCountDown({
  time: 60 * 1000,
  onFinish() {
    isCountdown.value = false
  },
})

const {
  value: phone,
  errorMessage: phoneErrorMsg,
  validate: validPhone,
  setValue: setPhone,
  resetField: resetPhone,
} = useField<string>('phone', fieldVerifyPhone)

const {
  value: phoneCode,
  errorMessage: phoneCodeErrorMsg,
  validate: valiPhoneCode,
  resetField: resetPhoneCode,
} = useField<string>('phoneCode', (value) => {
  if (!value)
    return t('请输入验证码')
  else if (value.length !== 6)
    return t('仅支持6位纯数字')
  return ''
}, { initialValue: '' })

const hasChangePhone = computed(() => `${area_code.value}-${phone.value}` !== userInfo.value?.phone)

const { runAsync: runMemberUpdate, loading: updatePhoneLoading } = useRequest(ApiMemberUpdate, {
  onSuccess() {
    Message.success(t('修改成功'))
    updateUserInfo()
  },
})

/** 发送手机验证码 */
const {
  runAsync: runAsyncSendPhoneSms,
  loading: phoneCaptchaLoading,
} = useRequest(() => ApiMemberPhoneSms({ phone: `${area_code.value}-${phone.value}`, type: 0 }), {
  onSuccess(res) {
    if (+res > 0) {
      reset(+res * 1000)
      start()
      isCountdown.value = true
    }
    else {
      reset()
      start()
      isCountdown.value = true
      Message.success(t('验证码发送成功'))
    }
  },
})

/** 点击重新发送 */
function onResendClick() {
  if (phoneCaptchaLoading.value)
    return
  runAsyncSendPhoneSms()
}

/** 检测是否存在 */
const { runAsync: runExists, loading: existLoading } = useRequest(ApiMemberExists, {
  onSuccess(res) {
    runMemberUpdate({
      record: {
        phone: `${area_code.value}-${phone.value}`,
      },
      uid: paramsData.value.uid,
    })
    // }
  },
})

/** 📱📱修改手机相关📱📱 */
const isPhoneVerified = computed(() => userInfo.value?.phone_check_state === 1)
const isSamePhoneNumber = computed(() => phone.value === userInfo.value?.phone.split('-')[1])
const phoneEditBtnText = computed(() => {
  if (userInfo.value?.phone) // && !isPhoneVerified.value && isSamePhoneNumber.value
    return isOpenMobileVerify.value ? t('验证') : t('保存')

  return t('保存')
})

// 区号接口数据有可能没有+号
function areaPlus(v?: string) {
  if (v && v.length)
    return v.includes('+') ? v : `+${v}`
}

function fieldVerifyPhone(): boolean {
  let b = false
  const _phone = phone.value
  if (!phone)
    b = false
  const areaCode = isPhoneVerified.value ? areaCodeLabel.value : area_code.value
  if (areaCode === '+63')
    b = !!(philippinePhoneReg.test(`+63${_phone}`) && _phone.length > 5 && _phone.length <= 18)
  else if (areaCode === '+86')
    b = !!chinaPhoneReg.test(`${_phone}`) && _phone.length > 5 && _phone.length <= 18
  else if (areaCode === '+55')
    b = !!brazilPhoneReg.test(`+55${_phone}`) && _phone.length > 5 && _phone.length <= 18
  else
    b = !!numberReg.test(_phone) && _phone.length > 5 && _phone.length <= 18
  if (!b)
    phoneErrorMsg.value = t('手机号码无效')
  else
    phoneErrorMsg.value = ''
  return b
}

// 提交
async function updatePhone() {
  phoneRef.value.setTouchTrue()
  await validPhone()
  if (isOpenMobileVerify.value) {
    codeRef.value.setTouchTrue()
    await valiPhoneCode()
  }
  if (phoneErrorMsg.value || (isOpenMobileVerify.value && phoneCodeErrorMsg.value))
    return
  if (!isSamePhoneNumber.value) {
    runExists({ ty: 3, val: `${area_code.value}-${phone.value}`, noNotify: true })
  }
  else {
    runMemberUpdate({
      record: {
        phone: `${area_code.value}-${phone.value}`,
      },
      uid: paramsData.value.uid,
    })
  }
}

watch(() => userInfo.value?.phone, (newValue) => {
  if (userInfo.value?.phone) {
    const arr = userInfo.value.phone.split('-')
    setPhone(arr[1])
    area_code.value = arr[0]
  }
}, { immediate: true })

// 监听区号数据加载完成，确保 area_code 有正确的值
watch(() => isAreaCodeDataReady.value, (isReady) => {
  if (isReady && areaCodeOptions.value.length > 0) {
    // 如果数据加载完成，检查当前 area_code 是否在可选项中
    const isValidOption = areaCodeOptions.value.some(option => option.value === area_code.value)
    if (!isValidOption) {
      // 如果当前值不在可选项中，设置为第一个可选项
      area_code.value = areaCodeOptions.value[0].value
    }
  }
  else if (isReady && !area_code.value) {
    // 如果数据加载完成但 area_code 还没有值，设置默认值
    area_code.value = countryCallingCode.value || '+86'
  }
}, { immediate: true })
</script>

<template>
  <div class="bg-[#fff] rounded-[8rem] p-[12rem]">
    <div class="text-[#0D2245] text-[18rem] font-[600] mb-[8rem] flex items-center">
      <span>{{ t('手机号码') }}</span>
      <span v-if="phoneVerified" class="bg-[#2BA471] text-[#fff] text-[12rem] font-[600] rounded-[45rem] h-[22rem] flex justify-center items-center px-[8rem] ml-[10rem]">{{ t('已验证') }}</span>
    </div>
    <div v-if="isComponent" class="text-[#6D7693] text-[14rem] font-[500] mb-[16rem]">
      {{ t('您必须验证您的电邮地址才能进行提款 ') }}
    </div>
    <div v-else class="text-[#6D7693] text-[14rem] font-[500] mb-[16rem]">
      {{ t('我们只服务国际电话区号列表中所列有的区域') }}
    </div>

    <PhBaseLabel :label="t('手机号码')" required class="mb-[16rem]">
      <PhBaseInput
        ref="phoneRef"
        v-model="phone"
        name="emailCode"
        type="text"
        msg-after-touched
        :msg="phoneErrorMsg"
        required
        inputmode="number"
        :placeholder="t('手机号码')"
      >
        <template #left>
          <div class="center h-full flex text-[#9DABC9]">
            <BaseImage v-if="area_code && area_code.length" class="w-[16rem]" :url="`/flag/${area_code.slice(1)}.webp`" />
            <PhBaseOriginSelect
              v-if="!showAreaCodeLoading"
              v-model="area_code"
              :options="safeAreaCodeOptionsFiltered"
              class="cursor-pointer"
            />
            <div v-else class="text-[12rem] text-[#9DABC9] px-[4rem]">
              {{ t('加载中...') }}
            </div>
          </div>
        </template>
      </PhBaseInput>
    </PhBaseLabel>

    <div v-if="isOpenMobileVerify && !phoneVerified" class="mb-[5rem]">
      <div v-if="isComponent && isOpenEmailVerify" class="flex items-center mb-[4rem]">
        <span class="text-[#0D2245] text-[14rem] font-[500]">{{ t('验证码') }}</span>
        <span class="text-[#F23038] text-[12rem] ml-[5rem] mr-[10rem]">*</span>
        <span class="text-[#6D7693] font-[500] mr-[4rem]">{{ t('没有收到验证码？') }}</span>
        <span class="text-[#F23038] font-[500] cursor-pointer" @click="emit('toggle')">{{ t('使用邮箱') }}</span>
      </div>
      <div v-else class="text-[#0D2245] text-[14rem] font-[500] mb-[4rem]">
        {{ t('验证码') }}<span data-v-934b1b0e="" class="text-[#F23038] text-[12rem] ml-[5rem]">*</span>
      </div>
      <div class="flex gap-[20rem]">
        <div class="flex-1">
          <PhBaseInput
            ref="codeRef"
            v-model="phoneCode"
            name="codeRef"
            type="text"
            msg-after-touched
            :msg="phoneCodeErrorMsg"
            required
            inputmode="number"
            :placeholder="t('验证码')"
          />
        </div>
        <PhBaseButton type="primary" :loading="phoneCaptchaLoading" :disabled="isCountdown || !!phoneCodeErrorMsg || !phone" class="h-[44rem] w-[110rem]" style="--ph-base-button-font-size: 14rem; --ph-base-button-font-weight: 500; --ph-base-button-border-color: #EBEBEB;--ph-base-button-secondary-background-color:#fff" @click="onResendClick">
          <span v-if="isCountdown">{{ `${t('重新获取')} ${current.seconds}s` }}</span>
          <span v-else>{{ t('获取验证码') }}</span>
        </PhBaseButton>
      </div>
    </div>
    <PhBaseButton v-if="!phoneVerified" type="primary" :loading="updatePhoneLoading" :disabled="!hasChangePhone" class="h-[46rem] w-full mt-[16rem]" style="--ph-base-button-font-size: 14rem; --ph-base-button-font-weight: 500; --ph-base-button-border-color: #EBEBEB;--ph-base-button-secondary-background-color:#fff" @click="updatePhone">
      <span>{{ phoneEditBtnText }}</span>
    </PhBaseButton>
  </div>
</template>
